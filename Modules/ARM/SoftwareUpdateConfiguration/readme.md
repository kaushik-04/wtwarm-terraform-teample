# Software Update Configuration

This module deploys a Software Update Configuration into an existing Automation Account.
Also known as Patch Management, Update Management and patch deployment schedules.

## Resource types

| Resource Type                                                          | Api Version |
| :--------------------------------------------------------------------- | :---------- |
| `Microsoft.Resources/deployments`                                      | 2020-06-01  |
| `Microsoft.Automation/automationAccounts/softwareUpdateConfigurations` | 2019-06-01  |

### Resource dependency

The following resources are required to be able to deploy this resource.

- Microsoft.Automation/automationAccounts

## Parameters

| Parameter Name            | Type   | Default Value                                                                           | Possible values                                                                                                                                             | Description                                                                                                                                                                                                                                                                                                                            |
| :------------------------ | :----- | :-------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `automationAccountName`   | string |                                                                                         |                                                                                                                                                             | Required. Name of the Automation Account to deploy the schedule to.                                                                                                                                                                                                                                                                    |
| `azureVirtualMachines`    | array  | []                                                                                      |                                                                                                                                                             | Optional. List of azure resource Ids for azure virtual machines in scope for the deployment schedule.                                                                                                                                                                                                                                  |
| `baseTime`                | string | [utcNow('u')]                                                                           |                                                                                                                                                             | Generated. Do not touch. Is used to provide the base time for time comparrison for startTime. If startTime is specified in HH:MM format, baseTime is used to check if the provided startTime has passed, adding one day before setting the deployment schedule.                                                                        |
| `cuaId`                   | string | Optional. Customer Usage Attribution id (GUID). This GUID must be previously registered |                                                                                                                                                             | Optional. Customer Usage Attribution id (GUID). This GUID must be previously registered                                                                                                                                                                                                                                                |
| `deploymentScheduleName`  | string |                                                                                         |                                                                                                                                                             | Required. The name of the Deployment schedule.                                                                                                                                                                                                                                                                                         |
| `description`             | string |                                                                                         |                                                                                                                                                             | Optional. The schedules description.                                                                                                                                                                                                                                                                                                   |
| `excludeUpdates`          | array  | []                                                                                      |                                                                                                                                                             | Optional. KB numbers or Linux packages excluded in the deployment schedule.                                                                                                                                                                                                                                                            |
| `expiryTime`              | string |                                                                                         |                                                                                                                                                             | Optional. The end time of the deployment schedule in ISO 8601 format. YYYY-MM-DDTHH:MM:SS, 2021-12-31T23:00:00                                                                                                                                                                                                                         |
| `expiryTimeOffsetMinutes` | int    | 0                                                                                       |                                                                                                                                                             | Optional. The expiry time's offset in minutes.                                                                                                                                                                                                                                                                                         |
| `frequency`               | string |                                                                                         | "OneTime","Hour","Day","Week","Month"                                                                                                                       | Required. The frequency of the deployment schedule. When using 'Hour', 'Day', 'Week' or 'Month', an interval needs to be provided.                                                                                                                                                                                                     |
| `includeUpdates`          | array  | []                                                                                      |                                                                                                                                                             | Optional. KB numbers or Linux packages included in the deployment schedule.                                                                                                                                                                                                                                                            |
| `interval`                | int    | 0                                                                                       | 0-100                                                                                                                                                       | Optional. The interval of the frequency for the deployment schedule. 1 Hour is every hour, 2 Day is every second day, etc.                                                                                                                                                                                                             |
| `isEnabled`               | bool   | True                                                                                    |                                                                                                                                                             | Optional. Enables the deployment schedule.                                                                                                                                                                                                                                                                                             |
| `location`                | string | [resourceGroup().location]                                                              |                                                                                                                                                             | Optional. Location for the resource.                                                                                                                                                                                                                                                                                                   |
| `maintenanceWindow`       | string | PT2H                                                                                    | [ISO 8601 Duration format](https://en.wikipedia.org/wiki/ISO_8601#Durations)                                                                                | Required. Maximum time allowed for the deployment schedule to run. Duration needs to be specified using the format PT[n]H[n]M[n]S as per ISO8601                                                                                                                                                                                       |
| `monthDays`               | array  | []                                                                                      | 1-31                                                                                                                                                        | Optional. Can be used with frequency 'Month'. Provides the specific days of the month to run the deployment schedule.                                                                                                                                                                                                                  |
| `monthlyOccurrences`      | array  | []                                                                                      |                                                                                                                                                             | Optional. Can be used with frequency 'Month'. Provides the pattern/cadence for running the deployment schedule in a month. Takes objects formed like this {occurance(int),day(string)}. Day is the name of the day to run the deployment schedule, the occurance specifies which occurance of that day to run the deployment schedule. |
| `nextRun`                 | string |                                                                                         |                                                                                                                                                             | Optional. The next run time of the deployment schedule in ISO 8601 format. YYYY-MM-DDTHH:MM:SS, 2021-12-31T23:00:00                                                                                                                                                                                                                    |
| `nextRunOffsetMinutes`    | int    | 0                                                                                       |                                                                                                                                                             | Optional. The next run time's offset in minutes.                                                                                                                                                                                                                                                                                       |
| `nonAzureComputerNames`   | array  | []                                                                                      |                                                                                                                                                             | Optional. List of names of non-azure machines in scope for the deployment schedule.                                                                                                                                                                                                                                                    |
| `nonAzureQueries`         | array  | []                                                                                      |                                                                                                                                                             | Optional. Array of functions from a Log Analytics workspace, used to scope the deployment schedule.                                                                                                                                                                                                                                    |
| `operatingSystem`         | string |                                                                                         | 'Windows', 'Linux'                                                                                                                                          | Required. The operating system to be configured by the deployment schedule.                                                                                                                                                                                                                                                            |
| `postTaskParameters`      | object |                                                                                         |                                                                                                                                                             | Optional. Parameters provided to the task running after the deployment schedule.                                                                                                                                                                                                                                                       |
| `postTaskSource`          | string |                                                                                         |                                                                                                                                                             | Optional. The source of the task running after the deployment schedule.                                                                                                                                                                                                                                                                |
| `preTaskParameters`       | object |                                                                                         |                                                                                                                                                             | Optional. Parameters provided to the task running before the deployment schedule.                                                                                                                                                                                                                                                      |
| `preTaskSource`           | string |                                                                                         |                                                                                                                                                             | Optional. The source of the task running before the deployment schedule.                                                                                                                                                                                                                                                               |
| `rebootSetting`           | string |                                                                                         | 'IfRequired', 'Never', 'RebootOnly', 'Always'                                                                                                               | Required. Reboot setting for the deployment schedule.                                                                                                                                                                                                                                                                                  |
| `scopeByLocations`        | array  | []                                                                                      |                                                                                                                                                             | Optional. Specify locations to which to scope the deployment schedule to.                                                                                                                                                                                                                                                              |
| `scopeByResources`        | array  | [subscription().id]                                                                     | ResourceIDs of subscriptions, resourceGroups and virtual machines                                                                                           | Optional. Specify the resources to scope the deployment schedule to.                                                                                                                                                                                                                                                                   |
| `scopeByTags`             | object |                                                                                         |                                                                                                                                                             | Optional. Specify tags to which to scope the deployment schedule to.                                                                                                                                                                                                                                                                   |
| `scopeByTagsOperation`    | string | All                                                                                     | 'All', 'Any'                                                                                                                                                | Optional. Enables the scopeByTags to require All (Tag A and Tag B) or Any (Tag A or Tag B).                                                                                                                                                                                                                                            |
| `startTime`               | string |                                                                                         | ISO 8601 [Date](https://en.wikipedia.org/wiki/ISO_8601#Dates) and [Time](https://en.wikipedia.org/wiki/ISO_8601#Times) format, YYYY-MM-DDTHH:MM:SS or HH:MM | Optional. The start time of the deployment schedule in ISO 8601 format. To specify a specific time use YYYY-MM-DDTHH:MM:SS, 2021-12-31T23:00:00. For schedules where we want to start the deployment as soon as possible, specify the time segment only in 24 hour format, HH:MM, 22:00.                                               |
| `timeZone`                | string | UTC                                                                                     | IANA ID or Windows Time Zone ID, i.e. Europe/London or America/New_York                                                                                     | Optional. Time zone for the deployment schedule. IANA ID or a Windows Time Zone ID.                                                                                                                                                                                                                                                    |
| `updateClassifications`   | array  | ['Critical','Security']                                                                 | 'Critical', 'Security', 'UpdateRollup', 'FeaturePack', 'ServicePack', 'Definition', 'Tools', 'Updates', 'Other'                                             | Optional. Update classification included in the deployment schedule.                                                                                                                                                                                                                                                                   |
| `weekDays`                | array  | []                                                                                      | 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'                                                                                | Optional. Required when used with frequency 'Week'. Specified the day of the week to run the deployment schedule.                                                                                                                                                                                                                      |

### Parameter Usage: `scopeByTags`

Provide tag keys, with an array of values, filtering in machines that should be included in the deployment schedule.

| Property name | Type  | Possible values | Description |
| :------------ | :---- | :-------------- | :---------- |
| \<tag key\>   | array | string          | tag values  |

```json
"scopeByTags": {
    "value": {
        "Update": [
            "Automatic"
        ],
        "MaintenanceWindow": [
            "1-Sat-22"
        ]
    }
}
```

### Parameter Usage: `monthlyOccurrences`

Occurrences of days within a month.

| Property name | Type   | Possible values                                                | Description                                                                          |
| :------------ | :----- | :------------------------------------------------------------- | :----------------------------------------------------------------------------------- |
| `occurance`   | int    | 1-5                                                            | Occurrence of the week within the month. Must be between 1 and 5, where 5 is "last". |
| `day`         | string | Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday | Day of the occurrence.                                                               |

```json
"monthlyOccurrences": {
    "value": [
        {
            "occurrence": 1,
            "day": "Monday"
        },
        {
            "occurrence": 2,
            "day": "Friday"
        }
    ]
}
```

## Outputs

| Output Name              | Type   | Description                                                               |
| :----------------------- | :----- | :------------------------------------------------------------------------ |
| `automationAccountName`  | string | The Automation Account the Software Update Configuration was deployed to. |
| `deploymentScheduleName` | string | The name of the Software Update Configuration.                            |
| `resourceGroupName`      | string | The Resource Group the Software Update Configuration was deployed to.     |
| `resourceId`             | string | The Resource Id of the Software Update Configuration.                     |

## Considerations

- *None*

## Additional resources

- [Template reference](https://docs.microsoft.com/en-us/azure/templates/microsoft.automation/automationaccounts/softwareupdateconfigurations)
- [ISO 8601 Time format](https://en.wikipedia.org/wiki/ISO_8601)
- [IANA time zone list](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones)
- [Update classifications - Update Management | Microsoft Docs](https://docs.microsoft.com/en-us/azure/automation/update-management/overview#update-classifications)
