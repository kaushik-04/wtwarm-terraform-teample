# Container Instance 1.0

| **Status** | <span style="color:orange">**DRAFT**</span> |
|--|--|
| **Version** | v0.1 |
| **Edited By** | @<EF2FFAF3-C53A-62F0-83E3-A447246632C7>   |
| **Date** | 18/02/2021  |
| **Approvers** |  |
| **Deployment documentation** |  |
| **To Do** | |

[[_TOC_]]

## 1. Introduction
### 1.1. Service Description
Azure Container Instances offers a simple way to run a container in Azure, without having to manage virtual machines and having to adopt a higher-level service.

Azure Container Instances is a great solution for a scenario that can operate in isolated containers, including simple applications, task automation, and build jobs.

In this version of the Certified Service, the Azure Container Instances can be deployed to schedule both Windows and Linux containers with the same API. 

Some features are currently restricted to Linux containers:

- Multiple containers per container group
- Volume mounting (Azure Files, emptyDir, GitRepo, secret)
- Resource usage metrics with Azure Monitor
- Virtual network deployment


## 2.      Architecture


### 2.1. High Level Design
The following figure describes the overall architecture for this service:

![aci_architecture.png](/.attachments/aci_architecture-cac8269d-0736-489b-a806-4c4aca2d369c.png)

### 2.2. Consumption endpoints (Data plane)
Container groups can share an external-facing IP address, one or more ports on that IP address, and a DNS label with a fully qualified domain name (FQDN). To enable external clients to reach a container within the group, the port on the IP address and from the container must expose.
| Consumption Endpoint (Data plane) | Port
| - | -
| https://{serviceName}.{region}.azurecontainer.io | 443


#### 2.2.1. Endpoint Access

The service will be deployed as a public endpoint allowing traffic from the Internet; access limited by authentication. This way we ensure that any external service access to this resource.

#### 2.2.2. Endpoint Authorization and Authentication
Azure Container Instances is a PaaS service and protected through RBAC rules.
Note: The service is hosting container images where Developers must ensure that only privileged users can access those containers in transit and at rest! 
Containers can spread across several clusters and Azure regions. Inventory all credential secrets, and require developers to use emerging secrets-management tools that are designed for container platforms. 

**RBAC Authorization**: 

| Role/Permission | Prod | Non-Prod| Description | 
|-----------------|-------------------------|------------------------|------------|
| Reader          | X          |  | Can be assigned to end-users who should be able to view service configuration.                                               |
| Contributor |         |   X                   | Can be assigned to developers who should be able to modify service configuration. |
| Owner |          X              |   X                   | Can be assigned to entities (service principals / managed identities) that need to create instances.                             |



### 2.3. Service Limits

All Azure services include certain default limits and quotas for resources and features. Availability of compute, memory, and storage resources for Azure Container Instances varies by region and operating system. [For details, see Resource availability for Azure Container Instances.](https://docs.microsoft.com/en-us/azure/container-instances/container-instances-quotas)

Use the List Usage API to review current quota usage in a region for a subscription.


### 2.4. Monitoring

Take advantage of solutions to scan container images in a private registry and identify potential vulnerabilities. It’s important to understand the depth of threat detection that the different solutions provide.

Azure Container Registry optionally integrates with Azure Security Center to automatically scan all Linux images pushed to a registry. Azure Security Center's integrated Qualys scanner detects image vulnerabilities, classifies them, and provides remediation guidance.

Security monitoring and image scanning solutions such as Twistlock and Aqua Security are also available through the Azure Marketplace.

Some best practices for monitoring are:
- Enable monitoring across all web apps and services: this way, you can easily visualize end-to-end transactions and connections across all components.
- Setup actionable alerts with notifications and/or remediation: Having a robust alerting pipeline is essential for any monitoring strategy and it is recommended to set up actionable alerts for all predictable failure states.
- Prepare role-based dashboards and workbooks for reporting.


## 3. Service Provisioning

### 3.1. Prerequisites

The following Azure resources need to be in place before this Certified Service can be provisioned:

- Resource Group

### 3.2. Deployment parameters


|                                     | **Prod**                                    | **Non**-Prod                                | **Implementation** | Implementation Status           |
|-------------------------------------|-----------------------------------------|-----------------------------------------|----------------|---------------------------------|
| **Subscription** | N/A | N/A | <span style="color:green">**PARAMETER**</span>| <span style="color:grey">**N/A**</span>| 
| **Resource Group**  | N/A | N/A |<span style="color:green">**PARAMETER**</span>| <span style="color:grey">**N/A**</span>|
| **Name** | <name> | <name> | <span style="color:green">**PARAMETER**</span>| <span style="color:green">**IMPLEMENTED**</span>|
| **Region** |West EU (fixed) <br> Enforced by Policy | West EU (fixed) <br> Enforced by Policy | <span style="color:green">**DEFAULT**</span>| <span style="color:green">**IMPLEMENTED<br>Policy on root**</span>|
| **SKU** | Premium (fixed) | Premium (fixed) | <span style="color:green">**DEFAULT**</span> |<span style="color:green">**IMPLEMENTED<br>Policy**</span> |
|**Connectivity method**|Public Endpoint (fixed)|Public Endpoint (fixed)|<span style="color:green">**DEFAULT**</span>|<span style="color:green">**IMPLEMENTED<br>Policy**</span>
<br>

## 4. Service Management 
All product-specific MSMCF controls - for the current product version - can be found on the table below:

|  **Title**                                                                                                                                                                                                                        |  **Functional Control   Description**                                                                                        |  **Category**                            |  **Product Assessment Q&A**                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |  **Implementation**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |  **Status**                                                              |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------              |-------------------------------------------------------------------------------------------------------        |----------------     |-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------              |------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |--------------------------------------------------  |
|  **M-STD02**   |  Health alerts are automatically   generated, correlated and   managed   based on event monitoring                             |  Standard                       |  Monitoring Resource Health alerts   covered on subscription level.               <br> -Health alerts are automatically triggered by Azure.            <br> -No product specific health alerting or dashboard/report   requirements.            <br> -No product specific health alerting or dashboard/report   requirements.            <br> -Guidance for DevOps teams about monitoring best practices to   be   documented on the wiki product   description.                         |  - This control is applied by   defining Resource Health Alerts on a subscription level, therefore   provided   for all certified   products/platforms.       <br>   <br> - Additional resource monitoring is under the   responsibility of each workload DevOps   team.                                                                                                                                                                                                                                                                                |   <span style="color:green">**Final**</span>     |
|  **M-STD05**                                                |  Disaster Recovery (DR) scenario’s   are applied and tested     periodically                                                 |  Standard                       |  Considerations for DR and higher   availability:      <br> -   Geo-replication option (mandatory)        <br> - General documentation available in the section Geo   Replication                                                                                                                                                                                                                                                                                                           |  <br>  - Since the deployment   is scripted, the DevOps team is capable of   deploying the Azure Container     Registry again in case of a disaster.       <br> - The customer is   responsible for choosing the Geo-replication     sites. Geo-replication enables an Azure container registry to function   as a   single registry, serving   multiple regions with multi-master regional     registries and thus functions as DR scenario.                                                                                                                                                                                                                                                                                          |   <span style="color:green">**Final**</span>     |
|  **M-STD06**        |  RTO / RPO requirements are   achieved for backup and restore                                                           |  Standard                       |  <br> - Ensure regular   backups are performed (mandatory)          <br>- Backup Container Registry (Mandatory)       <br> - Registry protection   (Optional)       <br> - Guidance   for DevOps teams about backup & restore best   practices to be documented on the wiki   product description.                                                                                                                                                                                            |  - The Azure DevOps Repo   (out-of-the -box functionality) used by the     DevOps team provides the capability to push/restore the images that   were   contained within the ACR.       <br>- The Azure Container  Registry is backed up in the form of geo  replication. Geo-replication enables an Azure container registry to   function   as a single registry,   serving multiple regions with multi-master regional   registries .       <br>- It is the responsibility   of the application teams to backup the     images.       <br>-   Applying an RBAC role to restrict the restore capabilities is   not applicable here (ACR images can be   just redeployed - from the     corresponding Repo)                         |   <span style="color:green">**Final**</span>      |

 

## 5. Security Controls for Container Registry

Microsoft Container Registry  best practices: 
All product-specific security controls - for the current product version - can be found on the table below:

| Index    | Security Requirement                                                                                 | Relevance                                                                                                                                                                                                                                         | Implementation details                                                                         | Policy Enforced / Audit | Design Status                                      |Implementation Status                                      |
|----------|------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------|-------------------------|---------------------------------------------|---------------------------------------------|
| CN-SR-01 | Use a secure protocol to encrypt data at transfer (Preferably TLS1.2 or later).                      | Not applicable. <BR>[Microsoft Azure resources negotiate TLS 1.2 by default.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#44-encrypt-all-sensitive-information-in-transit)                                                                                                                                                                                  |  NA                                                                                             |  NA                  | <span style="color:green">**FINAL**</span>  | <span style="color:green">**IMPLEMENTED BY DEFAULT**</span>
| CN-SR-02 | Secret and Key management needs to be done by a dedicated database/vault.                            | [Containers can spread across several clusters and Azure regions. To secure credentials required for logins or API access, ensure that only privileged users can access containers. Azure Key Vault is a cloud service that safeguards encryption keys and secrets for containerized applications.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#711-manage-azure-secrets-securely)                                                                                                                                                                                                                                    |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>
| CN-SR-03 | Encrypt information at rest (Disc encryption).                                                       | [By default, all deployment data in Azure Container Instances is encrypted at rest using Microsoft-managed keys.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#48-encrypt-sensitive-information-at-rest)                                                                                                                                                                                                                               |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:green">**IMPLEMENTED BY DEFAULT**</span>
| CN-SR-04 | Maintain an inventory of sensitive Information.                                                      | [Resources will get tag per organizational needs.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#64-maintain-an-inventory-of-approved-azure-resources-and-software-titles)                                                                                                                                                                                 |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>
| CN-SR-05 | Use an active discovery tool to identify sensitive data.                                             | [Tag container groups that may be processing sensitive information as such and implement third-party solution if required for compliance purposes.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#45-use-an-active-discovery-tool-to-identify-sensitive-data)                                                                                                                                                                                                                                   |  Deployment parameter                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>
| CN-SR-06 | Protect the database from permanently deleting data by enabling soft delete functionality.           |NA                                                                                                                                                                              |  NA                                                           |  NA| <span style="color:green">**FINAL**</span>  | <span style="color:grey">**N/A**</span>
| CN-SR-07 | Ensure regular automated back ups                                                                    |[Enable Azure Backup and configure the backup source (such as a file share mounted to container groups), as well as the desired frequency and retention period.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#91-ensure-regular-automated-back-ups)  |  NA                                                                       |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>
| CN-SR-08 | Enforce the use of Azure Active Directory.                                                           | Azure Active Directory can only be used for the IAM at the Control Plane. [Secure credentials required for logins or API access of the hosted image, must ensure that only privileged users can access those containers in transit and at rest.(https://docs.microsoft.com/en-us/azure/container-instances/container-instances-image-security#protect-credentials)|  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span> 
| CN-SR-09 | Follow the principle of least privilege.                                                             | [RBAC access control](https://docs.microsoft.com/en-us/azure/container-registry/container-registry-roles).    | - DevOps Service Principals responsible for building and pushing images will be assigned **AcrPush**. <br> - Service Principals and Managed Identities consuming the images will only be assigned **AcrPull**.  |     |  |
| CN-SR-10 | Configure security log storage retention.                                                            | Log Analytics retention is configured on the LAW product itself. More information: https://docs.microsoft.com/en-us/azure/key-vault/key-vault-logging                                  |  NA                                                                                 | NA| <span style="color:green">**FINAL**</span>  | <span style="color:grey">**N/A**</span> 
| CN-SR-11 | Enable alerts for anomalous activity.                                                                | [Use Log Analytics Workspace for monitoring and alerting on anomalous activity found in security logs and events.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#27-enable-alerts-for-anomalous-activity)                                                                                                                                                                                                                                                         |  This control is inherited from the Azure Security Center configuration applied at the Subscription Level.     |  Enforced| <span style="color:green">**FINAL**</span>  |  <span style="color:green">**IMPLEMENTED BY DEFAULT**</span>
| CN-SR-12 | Configure central security log management.                                                           |  [Ingest logs via Azure Monitor to aggregate security data generated by an Azure container group.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#22-configure-central-security-log-management)                                                                                                    | Inherit                                                                                | Enforced |<span style="color:green">**FINAL**</span> | <span style="color:green">**IMPLEMENTED<br>Policy on Root**</span>
| CN-SR-13 | [Azure Container Instances includes built-in support for sending container group logs and event data, and container logs, to Azure Monitor logs.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#23-enable-audit-logging-for-azure-resources)                                                                                                                                                                                            | It will be enabled using Azure Monitor for the collection of resource logs. |Inherit| Enforced |<span style="color:green">**FINAL**</span> | <span style="color:green">**IMPLEMENTED<br>Policy on Root**</span> |  
| CN-SR-14 | Enable MFA and conditional access with MFA.                                                          | Not applicable. Inherited from Azure AD                                                                                                                                                                                                                                  |  NA                                                                                            |  NA (inherited)                    | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span> 
| CN-SR-15 | Protect resources using Network Security Groups or Azure Firewall on your Virtual Network.     | Not directly applicable. Needs to be implemented on NSG/Azure Firewall level. Access only for the LZ resources                                                                                                                                     |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>
| CN-SR-16 | Ensure that the endpoint protection for all Virtual Machines is installed.                           | Not applicable.                                                                                                                                                                                                                                   |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>
| CN-SR-17 | Secure outbound communication to the internet.                                                       | Not applicable. contoso cloud-native product is directly connect to the Azure backbone without use of VNET.                                                                                                                                                                                                                                   |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  | <span style="color:grey">**N/A**</span>
| CN-SR-18 | Enable JIT network access.                                                                           | Not applicable.                                                                                                                                                                                                                                   |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  | <span style="color:grey">**N/A**</span>
| CN-SR-19 | Run automated vulnerability scanning tools.                                                          |   [ Implement solutions to scan container images in a private registry and identify potential vulnerabilities.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#51-run-automated-vulnerability-scanning-tools)      |  This control is inherited from the Azure Security Center configuration applied at the Subscription Level.     |  NA                     | <span style="color:green">**FINAL**</span>  |  <span style="color:green">**IMPLEMENTED BY DEFAULT**</span>
| CN-SR-20 | Use automated tools to monitor network resource configurations and detect changes.                   | Not applicable. contoso cloud-native product is directly connect to the Azure backbone without use of VNET.                                                                                                                                                                                                                            |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  | <span style="color:grey">**N/A**</span>
| CN-SR-21 | Disable remote user access ports (RDP,SSH,Telnet,FTP).                                               | [Not applicable. An extension of ensuring that the environment uses only approved images is to permit only the use of approved container registries. Requiring the use of approved container registries reduces the exposure to risk by limiting the potential for the introduction of unknown vulnerabilities or security issues.](https://docs.microsoft.com/en-us/azure/container-instances/container-instances-image-security#ensure-the-integrity-of-images-throughout-the-lifecycle)                                                                                                                                                                                                                                  |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>
| CN-SR-22 | Enable automated Patching/ Upgrading.                                                                | Not applicable.  [Microsoft performs patch management on the underlying systems that support running containers. It is recommended to run for instance, Azure Container Registry tasks to automate updates to application images in a container registry based on security patches or other updates in base OS images.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#52-deploy-automated-operating-system-patch-management-solution)                                                                                                                                                                                                                                  |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>
| CN-SR-23 | Enable transparent data encryption.                                                                  | Not applicable. [By default, all deployment data in Azure Container Instances is encrypted at rest using Microsoft-managed keys.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#48-encrypt-sensitive-information-at-rest)                                                                                                                                                                                                                                   |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>
| CN-SR-24 | Enable OS vulnerabilities recommendations.                                                           | Not applicable. Microsoft performs patch management on the underlying systems that support running containers.                                                                                                                                                                                                                                  |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>
| CN-SR-25 | Configure firewall rules of existing firewalls if necessary.                                         | Firewall can be enabled and configured on he Container Registry, but at deployment we will follow the public by default security principles and open the firewall to all traffic.                                                                                                                                                                     |  NA                                                           |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:green">**IMPLEMENTED**</span>
| CN-SR-26 | Enable command-line audit logging.                                                                   | Not applicable. [If needed, configure console logging in a running container instance.](https://docs.microsoft.com/en-us/azure/container-instances/security-baseline#210-enable-command-line-audit-logging)                                                                                                                                                                                                                                   |  Can be part of the container deployment pipeline.                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>  
| CN-SR-27 | Enable conditional access control.                                                                   | Not applicable (only Service principal has access to AKV).                                                                                                                                                                                        |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>  
| CN-SR-28 | Specify service tags to define network access controls on network security groups or Azure Firewall. | We have tags defined in the ARM template.                                                                                                                                                                                                                                   |  Embeded in the ARM template                                                                                            |    NA                 | <span style="color:green">**FINAL**</span>  | <span style="color:green">**IMPLEMENTED**</span>
| CN-SR-29 | Use Corporate Active Directory Credentials.                                                          | Azure AD is the authentication mechanism, if AAD is synchronized with Corporate Active Directory then this requirement is compliant.                                                                                                              |  NA                                                                                            |  NA                     | <span style="color:green">**FINAL**</span>  |<span style="color:grey">**N/A**</span>

## 6. Implemented Policies

This section describes the policies which will be implemented for Container Registry.
These policies will be assigned when deploying a Container Registry or when deploying a Subcription/Management Group, this separation will be discussed below.

| Policy | Description | Implementation Scope
|--|--|--|
|Enforce SKUs policy|This policy restrict the SKUs you can specify when deploying Container Registry|Subscription |
|Collect Activity Logs with Azure Monitor and send it to Log Analytics and Event Hub| This policy checks whether the Container Instance Logs are collected with Azure Monitor and send to Log analytics workspace and Event Hub | Deployed on each Subscription or Management group with the relevant Ids|
|Disable Admin user| This policy checks whether the ACR admin user is disabled|Deployed on each Subscription or Management group with the relevant Ids|
